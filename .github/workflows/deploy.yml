name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
      
      - name: ğŸ“¦ Inject Version Information
        run: |
          # íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
          BUILD_TIME=$(date -u +"%Y%m%d%H%M%S")
          BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          COMMIT_SHA_SHORT="${GITHUB_SHA:0:7}"
          
          echo "=========================================="
          echo "ğŸ“¦ Build Version: $BUILD_TIME"
          echo "ğŸ“… Build Date: $BUILD_DATE"
          echo "ğŸ”– Commit: $COMMIT_SHA_SHORT"
          echo "ğŸ”¢ Run Number: ${{ github.run_number }}"
          echo "=========================================="
          
          # ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd canvas-tavern-defense
          
          # src ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ì„ ê²½ìš°)
          mkdir -p src
          
          # version.js ìë™ ìƒì„±
          cat > src/version.js <<'EOF'
          // âš ï¸ AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
          // This file is automatically generated by GitHub Actions
          
          export const APP_VERSION = 'BUILD_TIME_PLACEHOLDER';
          export const BUILD_DATE = 'BUILD_DATE_PLACEHOLDER';
          export const COMMIT_SHA = 'COMMIT_SHA_PLACEHOLDER';
          export const GITHUB_RUN_NUMBER = RUN_NUMBER_PLACEHOLDER;
          EOF
          
          # í”Œë ˆì´ìŠ¤í™€ë” ì¹˜í™˜
          sed -i "s/BUILD_TIME_PLACEHOLDER/$BUILD_TIME/g" src/version.js
          sed -i "s/BUILD_DATE_PLACEHOLDER/$BUILD_DATE/g" src/version.js
          sed -i "s/COMMIT_SHA_PLACEHOLDER/$COMMIT_SHA_SHORT/g" src/version.js
          sed -i "s/RUN_NUMBER_PLACEHOLDER/${{ github.run_number }}/g" src/version.js
          
          echo "âœ… version.js created:"
          cat src/version.js
          
          # index.html ë²„ì „ ì£¼ì…
          if grep -q 'src="src/main.js"' index.html; then
            sed -i "s|src/main.js\"|src/main.js?v=$BUILD_TIME\"|g" index.html
            echo "âœ… index.html updated with version parameter"
          else
            echo "âš ï¸ Warning: Could not find 'src/main.js' in index.html"
          fi
          
          # ê²°ê³¼ í™•ì¸
          echo "=========================================="
          echo "ğŸ“„ index.html script tag:"
          grep "src/main.js" index.html || echo "Not found"
          echo "=========================================="
      
      - name: ğŸ“Š Generate Deployment Summary
        run: |
          echo "### ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Number** | \`${{ github.run_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Author** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Deployment URL" >> $GITHUB_STEP_SUMMARY
          echo "https://${{ github.repository_owner }}.github.io/HIMITU_STD/canvas-tavern-defense/" >> $GITHUB_STEP_SUMMARY
      
      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./canvas-tavern-defense
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy: Build #${{ github.run_number }}'
      
      - name: âœ… Deployment Complete
        run: |
          echo "=========================================="
          echo "ğŸ‰ Deployment Successful!"
          echo "ğŸŒ URL: https://${{ github.repository_owner }}.github.io/HIMITU_STD/canvas-tavern-defense/"
          echo "ğŸ“¦ Version: $(date -u +"%Y%m%d%H%M%S")"
          echo "=========================================="
