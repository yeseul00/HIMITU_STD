# ì—°ìŠµ í”„ë¡œì íŠ¸ #4: ê²Œì„ ë°ì´í„° êµ¬ì¡° ì„¤ê³„

> **ì˜ˆìƒ ì†Œìš” ì‹œê°„**: 2-3ì‹œê°„  
> **ë‚œì´ë„**: â­â­ (ì´ˆê¸‰-ì¤‘ê¸‰)  
> **Tavern Defense ì—°ê´€ë„**: â­â­â­â­ (ë†’ìŒ)

---

## ğŸ“Œ í”„ë¡œì íŠ¸ ê°œìš”

### ëª©í‘œ

Tavern Defense ê²Œì„ì˜ **ë°ì´í„° êµ¬ì¡°**ë¥¼ ë¯¸ë¦¬ ì„¤ê³„í•˜ê³ , CloudStorage ì œí•œì‚¬í•­ì„ ê³ ë ¤í•œ ì €ì¥ ì‹œìŠ¤í…œì„ êµ¬í˜„í•©ë‹ˆë‹¤.

### ì™œ ì¤‘ìš”í•œê°€?

> **ì°°ìŠ¤**: "í…Œì´ë¸” ì„¤ê³„ë§Œ í•˜ë©´ ë˜ê² ë‹¤."  
> (ê¸°ìˆ ìŠ¤íƒ ëª…ì„¸ì„œ v1.1)

ê²Œì„ ê¸°íšì„œê°€ ë‚˜ì˜¤ê¸° ì „ì— **ë°ì´í„° êµ¬ì¡°ì˜ ë¼ˆëŒ€**ë¥¼ ë¯¸ë¦¬ ì¡ì•„ë‘ë©´:

1. ê¸°íšì„œ í™•ì • í›„ ë¹ ë¥´ê²Œ êµ¬í˜„ ê°€ëŠ¥
2. CloudStorage ì œí•œ(4KB/ê°’)ì— ë§ëŠ” ì„¤ê³„ ê²½í—˜
3. ìƒíƒœ ê´€ë¦¬ íŒ¨í„´ ì´í•´

---

## ğŸ“Š Tavern Defense ì˜ˆìƒ ë°ì´í„° êµ¬ì¡°

### ì „ì²´ ê²Œì„ ìƒíƒœ

```javascript
const gameState = {
  // ë©”íƒ€ ì •ë³´
  version: "0.1.0",
  lastSaved: 1704067200000, // timestamp

  // í”Œë ˆì´ì–´ ì •ë³´
  player: {
    gold: 1000,
    reputation: 50,
    day: 1,
  },

  // íƒ€ì¼/ê±´ë¬¼ ë°°ì¹˜
  tiles: [
    { id: 1, type: "kitchen", level: 1, x: 0, y: 0 },
    { id: 2, type: "brewery", level: 2, x: 1, y: 0 },
    // ...
  ],

  // ì—…ê·¸ë ˆì´ë“œ ìƒíƒœ
  upgrades: {
    kitchen_speed: 1,
    combat_damage: 2,
    defense_hp: 1,
  },

  // ì§„í–‰ ìƒíƒœ
  progress: {
    currentWave: 1,
    maxWaveCleared: 5,
    tutorialCompleted: true,
  },

  // í†µê³„
  stats: {
    totalEnemiesKilled: 150,
    totalGoldEarned: 5000,
    totalDaysPlayed: 10,
  },
};
```

---

## ğŸ—“ï¸ ì‘ì—… ê³„íš (2-3ì‹œê°„)

### Phase 1 (1ì‹œê°„): ë°ì´í„° êµ¬ì¡° ì„¤ê³„ ë¬¸ì„œ

#### ì‘ì—… ë‚´ìš©

```
â–¡ í•µì‹¬ ì—”í‹°í‹° ì •ì˜ (Player, Tile, Enemy, Wave ë“±)
â–¡ ê° ì—”í‹°í‹° ì†ì„± ì •ì˜
â–¡ ì—”í‹°í‹° ê°„ ê´€ê³„ ì •ì˜
â–¡ TypeScript íƒ€ì… ì •ì˜ (ì„ íƒ)
â–¡ Mermaid ER ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„±
```

#### ER ë‹¤ì´ì–´ê·¸ë¨

```mermaid
erDiagram
    GAME_STATE ||--|| PLAYER : contains
    GAME_STATE ||--|{ TILE : contains
    GAME_STATE ||--|| UPGRADES : contains
    GAME_STATE ||--|| PROGRESS : contains
    GAME_STATE ||--|| STATS : contains

    PLAYER {
        int gold
        int reputation
        int day
    }

    TILE {
        int id
        string type
        int level
        int x
        int y
    }

    UPGRADES {
        int kitchen_speed
        int combat_damage
        int defense_hp
    }

    PROGRESS {
        int currentWave
        int maxWaveCleared
        bool tutorialCompleted
    }
```

---

### Phase 2 (1ì‹œê°„): ì €ì¥ ì‹œìŠ¤í…œ êµ¬í˜„

#### ì‘ì—… ë‚´ìš©

```
â–¡ SaveManager í´ë˜ìŠ¤ ì„¤ê³„
â–¡ CloudStorage ì œí•œ ëŒ€ì‘ (4KB/ê°’)
â–¡ ë°ì´í„° ì••ì¶•/ë¶„í•  ì „ëµ
â–¡ ìë™ ì €ì¥ íƒ€ì´ë¨¸
â–¡ ë²„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œì§
â–¡ ê°œë°œ ëª¨ë“œ í´ë°± (localStorage)
```

#### í•µì‹¬ ì½”ë“œ

```javascript
// SaveManager.js
export class SaveManager {
  constructor() {
    this.saveKey = "tavern_defense_save";
    this.configKey = "tavern_defense_config";
    this.autoSaveInterval = 60000; // 1ë¶„
  }

  // ì €ì¥ (CloudStorage ì œí•œ ëŒ€ì‘)
  async save(gameState) {
    const data = {
      version: gameState.version,
      lastSaved: Date.now(),
      ...gameState,
    };

    const jsonStr = JSON.stringify(data);

    // 4KB ì œí•œ ì²´í¬
    if (jsonStr.length > 4096) {
      console.warn("ë°ì´í„° í¬ê¸° ì´ˆê³¼, ë¶„í•  ì €ì¥ í•„ìš”");
      return this.saveChunked(data);
    }

    return await cloudStorage.setItem(this.saveKey, data);
  }

  // ë¶„í•  ì €ì¥ (ëŒ€ìš©ëŸ‰ ë°ì´í„°ìš©)
  async saveChunked(data) {
    const chunks = this.splitData(data);
    const promises = chunks.map((chunk, i) =>
      cloudStorage.setItem(`${this.saveKey}_${i}`, chunk)
    );

    // ì²­í¬ ê°œìˆ˜ ì €ì¥
    await cloudStorage.setItem(`${this.saveKey}_meta`, {
      chunkCount: chunks.length,
    });

    return Promise.all(promises);
  }

  // ë°ì´í„° ë¶„í• 
  splitData(data) {
    const str = JSON.stringify(data);
    const chunkSize = 3500; // ì—¬ìœ  ìˆê²Œ
    const chunks = [];

    for (let i = 0; i < str.length; i += chunkSize) {
      chunks.push(str.slice(i, i + chunkSize));
    }

    return chunks;
  }

  // ë¡œë“œ
  async load() {
    // ë©”íƒ€ ë°ì´í„° í™•ì¸
    const meta = await cloudStorage.getItem(`${this.saveKey}_meta`);

    if (meta?.chunkCount) {
      return this.loadChunked(meta.chunkCount);
    }

    return await cloudStorage.getItem(this.saveKey);
  }

  // ë¶„í•  ë¡œë“œ
  async loadChunked(chunkCount) {
    const chunks = [];
    for (let i = 0; i < chunkCount; i++) {
      chunks.push(await cloudStorage.getItem(`${this.saveKey}_${i}`));
    }
    return JSON.parse(chunks.join(""));
  }

  // ë²„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜
  migrate(data, targetVersion) {
    const migrations = {
      "0.1.0": (d) => ({ ...d, newField: "default" }),
      "0.2.0": (d) => ({ ...d, anotherField: 0 }),
    };

    let current = data;
    while (current.version !== targetVersion) {
      const migrateFn = migrations[current.version];
      if (!migrateFn) break;
      current = migrateFn(current);
    }

    return current;
  }
}
```

---

### Phase 3 (30ë¶„-1ì‹œê°„): í…ŒìŠ¤íŠ¸ í˜ì´ì§€

#### ì‘ì—… ë‚´ìš©

```
â–¡ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ UI ìƒì„±
â–¡ ë°ì´í„° ìƒì„±/ì €ì¥/ë¡œë“œ ë²„íŠ¼
â–¡ ì €ì¥ëœ ë°ì´í„° JSON ë·°ì–´
â–¡ ë°ì´í„° í¬ê¸° í‘œì‹œ
â–¡ ì••ì¶•ë¥  í™•ì¸
```

#### í…ŒìŠ¤íŠ¸ UI

```html
<!DOCTYPE html>
<html>
  <head>
    <title>Tavern Defense - Data Test</title>
  </head>
  <body>
    <h1>ğŸ“Š ê²Œì„ ë°ì´í„° í…ŒìŠ¤íŠ¸</h1>

    <section>
      <h2>ë°ì´í„° ìƒì„±</h2>
      <button onclick="generateTestData()">í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±</button>
      <button onclick="generateLargeData()">ëŒ€ìš©ëŸ‰ ë°ì´í„° ìƒì„±</button>
    </section>

    <section>
      <h2>ì €ì¥/ë¡œë“œ</h2>
      <button onclick="saveData()">ğŸ’¾ ì €ì¥</button>
      <button onclick="loadData()">ğŸ“‚ ë¡œë“œ</button>
      <button onclick="clearData()">ğŸ—‘ï¸ ì‚­ì œ</button>
    </section>

    <section>
      <h2>ë°ì´í„° ì •ë³´</h2>
      <p>í¬ê¸°: <span id="dataSize">-</span> bytes</p>
      <p>CloudStorage ì œí•œ: 4,096 bytes</p>
      <p>ìƒíƒœ: <span id="status">-</span></p>
    </section>

    <section>
      <h2>JSON ë·°ì–´</h2>
      <pre
        id="jsonViewer"
        style="background:#f5f5f5; padding:10px; overflow:auto; max-height:400px;"
      ></pre>
    </section>

    <script type="module" src="./test.js"></script>
  </body>
</html>
```

---

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
practice/game-data-design/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ data-model.md          # ë°ì´í„° ëª¨ë¸ ë¬¸ì„œ
â”‚   â”œâ”€â”€ er-diagram.md          # ER ë‹¤ì´ì–´ê·¸ë¨
â”‚   â””â”€â”€ storage-strategy.md    # ì €ì¥ ì „ëµ ë¬¸ì„œ
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ GameState.js       # ê²Œì„ ìƒíƒœ íƒ€ì… ì •ì˜
â”‚   â”‚   â”œâ”€â”€ Player.js          # í”Œë ˆì´ì–´ ëª¨ë¸
â”‚   â”‚   â”œâ”€â”€ Tile.js            # íƒ€ì¼ ëª¨ë¸
â”‚   â”‚   â””â”€â”€ constants.js       # ìƒìˆ˜ ì •ì˜
â”‚   â”œâ”€â”€ storage/
â”‚   â”‚   â”œâ”€â”€ CloudStorage.js    # CloudStorage ë˜í¼
â”‚   â”‚   â””â”€â”€ SaveManager.js     # ì €ì¥ ê´€ë¦¬ì â­
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ compression.js     # ë°ì´í„° ì••ì¶• ìœ í‹¸
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ index.html             # í…ŒìŠ¤íŠ¸ í˜ì´ì§€
â”‚   â””â”€â”€ test.js                # í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
â””â”€â”€ README.md
```

---

## ğŸ“‹ CloudStorage ì œí•œ ëŒ€ì‘ ì „ëµ

### ì œí•œì‚¬í•­ ì •ë¦¬

| ì œí•œ    | ê°’          | ëŒ€ì‘             |
| ------- | ----------- | ---------------- |
| í‚¤ ê¸¸ì´ | 128ì       | ê°„ê²°í•œ í‚¤ ë„¤ì´ë° |
| ê°’ í¬ê¸° | **4,096ì** | ë¶„í•  ì €ì¥        |
| í‚¤ ê°œìˆ˜ | 1,024ê°œ     | ì¶©ë¶„í•¨           |

### ë°ì´í„° í¬ê¸° ì¶”ì •

```javascript
// ì˜ˆìƒ ë°ì´í„° í¬ê¸° ê³„ì‚°
const estimatedSize = {
  meta: 50, // version, timestamp
  player: 100, // gold, reputation, day
  tiles: 50 * 20, // 20ê°œ íƒ€ì¼ Ã— 50bytes
  upgrades: 200, // ì—¬ëŸ¬ ì—…ê·¸ë ˆì´ë“œ
  progress: 100, // ì§„í–‰ ìƒíƒœ
  stats: 150, // í†µê³„
  total: 1600, // ì•½ 1.6KB
};

// ê²°ë¡ : ê¸°ë³¸ ì„¸ì´ë¸ŒëŠ” 4KB ì´ë‚´ë¡œ ì¶©ë¶„
// íƒ€ì¼ ê°œìˆ˜ê°€ ë§ì•„ì§€ë©´ ë¶„í•  í•„ìš”
```

### ì••ì¶• ì „ëµ (ì„ íƒ)

```javascript
// í‚¤ ì¶•ì•½ (ì•½ 30% ì ˆì•½)
const compactState = {
  v: "0.1.0",        // version
  t: Date.now(),     // timestamp
  p: { g: 1000, r: 50, d: 1 },  // player: gold, reputation, day
  // ...
};

// ë°°ì—´ ì¶•ì•½
const tiles = [[1,"kitchen",1,0,0], [2,"brewery",2,1,0]];
// vs
const tiles = [
  { id: 1, type: "kitchen", level: 1, x: 0, y: 0 },
  ...
];
```

---

## ğŸ¯ ì‚°ì¶œë¬¼ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë¬¸ì„œ

- [ ] ë°ì´í„° ëª¨ë¸ ì •ì˜ì„œ (data-model.md)
- [ ] ER ë‹¤ì´ì–´ê·¸ë¨ (Mermaid)
- [ ] ì €ì¥ ì „ëµ ë¬¸ì„œ (storage-strategy.md)

### ì½”ë“œ

- [ ] GameState íƒ€ì… ì •ì˜
- [ ] SaveManager í´ë˜ìŠ¤
- [ ] CloudStorage ë˜í¼
- [ ] í…ŒìŠ¤íŠ¸ í˜ì´ì§€

### í…ŒìŠ¤íŠ¸

- [ ] ì €ì¥/ë¡œë“œ ë™ì‘ í™•ì¸
- [ ] 4KB ì´ìƒ ë°ì´í„° ë¶„í•  ì €ì¥ í™•ì¸
- [ ] ë²„ì „ ë§ˆì´ê·¸ë ˆì´ì…˜ ë™ì‘ í™•ì¸

---

## ğŸ”— ì°¸ê³  ìë£Œ

| ìë£Œ                  | URL                                                 |
| --------------------- | --------------------------------------------------- |
| CloudStorage API      | https://core.telegram.org/bots/webapps#cloudstorage |
| JSON ì••ì¶• ë¼ì´ë¸ŒëŸ¬ë¦¬  | https://github.com/pieroxy/lz-string                |
| ê²Œì„ ì„¸ì´ë¸Œ ì„¤ê³„ íŒ¨í„´ | https://gameprogrammingpatterns.com/contents.html   |

---

## âœ… ì™„ë£Œ ê¸°ì¤€

1. ë°ì´í„° ëª¨ë¸ ë¬¸ì„œ ì‘ì„± ì™„ë£Œ
2. ER ë‹¤ì´ì–´ê·¸ë¨ Mermaidë¡œ ì‘ì„±
3. SaveManager í´ë˜ìŠ¤ êµ¬í˜„
4. ë¶„í•  ì €ì¥ ë¡œì§ êµ¬í˜„
5. í…ŒìŠ¤íŠ¸ í˜ì´ì§€ì—ì„œ ì €ì¥/ë¡œë“œ ë™ì‘ í™•ì¸
6. 4KB ì´ˆê³¼ ë°ì´í„° ë¶„í•  ì €ì¥ í™•ì¸

---

## ğŸ’¡ Tavern Defense ì§ì ‘ ì ìš©

ì´ í”„ë¡œì íŠ¸ì˜ ì‚°ì¶œë¬¼ì€ **ê·¸ëŒ€ë¡œ ë³µì‚¬**í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥:

```
âœ… models/GameState.js â†’ src/data/GameState.js
âœ… storage/SaveManager.js â†’ src/data/SaveManager.js
âœ… storage/CloudStorage.js â†’ src/telegram/CloudStorage.js
```

---

_ê¸°íšì„œê°€ í™•ì •ë˜ë©´ ì´ êµ¬ì¡°ì— ì„¸ë¶€ ë‚´ìš©ë§Œ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤!_
